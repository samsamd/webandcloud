<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Tiny Pet</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">




<script src="https://unpkg.com/mithril/mithril.js"></script>
	<meta name="google-signin-scope" content="profile email">
	<meta name="google-signin-client_id" content="53230070017-qglnlh23t1g8u04eqp9hogqpfqe2vj8o.apps.googleusercontent.com">
    <script src="https://apis.google.com/js/platform.js"></script>
    
 <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
 <style>
     ul {
		  list-style-type: none;
		  margin: 0;
		  padding: 0;
		  overflow: hidden;
		  background-color: #ffffff;
		}
		
		li {
		  float: left;
		}
		
		li div {
		  display: block;
		  color: black;
		  text-align: center;
		  padding: 14px 16px;
		  text-decoration: none;
		}
		
     li div:hover {
		  cursor : pointer;
		}
    .navbar-default {
    background-color: #f8f8f8;
    border-color: #e7e7e7;
    }
    .navbar-static-top {
    border-width: 0 0 1px;
    }       
 </style>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>   

</head>
<body>
    <script>

var navbar={
        searchtag:null,
		view: function() {
			return m('div', [
				m('nav',{class:'navbar navbar-default navbar-static-top'},
						m("ul",{class:"nav navbar-nav collapse navbar-collapse"},
							m("li",{},
							m("h1", {class: 'title'}, 'TinyPet')),
							m("li",{},m('div',{onclick: function(e) {m.route.set("/new")}},"Créer une pétition")),
							m("li",{},m('div',{
								onclick: function(e) {
									Petition.loadListOwner(),
                                      m.route.set("/myPet")}},
                                      "Les pétitions signées")),
							m("li",{},m('div',{
								onclick: function(e) {
									Petition.loadList(),
									m.route.set("/home")
								}},
								"Le top 100 des pétitions")),
							m("li",{},m('div',{
								onclick: function(e) {
									gapi.auth2.getAuthInstance().signOut().then(function () {
										console.log('User signed out.');
							      		location.reload();
							    	})
							    }}
                                ,"Déconnexion")),
                                //Début barre de recherche
                            m("li",{},m('div',[m('input[type=search][placeholder=Recherche via un tag]',{
                                class: 'input is-rounded',
                                id: 'search',
                                oninput : function(e) {
                                    navbar.searchtag = e.target.value
                                }
                            }),
                            m('button', {
                                class :'button',
                                onclick : function() {
                                    if(navbar.searchtag==null) {
                                        alert("Veuillez renseignez un tag !");
                                    } else {
                                    Petition.search(navbar.searchtag),
                                    navbar.searchtag=null
                                }
                                }
                            },"Search")])    
                        )
                        //Fin barre de recherche
                    )
                )	
			])
		}
}

    var CreatePetition={
  titre : ' ',
  body : ' ',
  owner : ' ',
  tag:'',
  User : ' ',
 }
    var NewPetitionView={
	    view: function() {
		return m('div', [
			m("div", {},m(navbar)),
	   			m('div',{class: 'tile is-ancestor'},[
		   	        m("div", {class: 'tile'}, m('div',{class:'tile is-child box'},
					m('div',{class:'subtitle'},"Créer une pétition"),
					m("label",{for:"titre"},"Nom de la pétition :"),
					m("input[type=text][placeholder=Titre]", {
						class: 'input is-rounded',
						id: 'titre',
						 oninput: function (e) {
							 CreatePetition.titre=e.target.value},
                         }),
                    m('br'),
                    m("label",{for:"description"},"Description :"),
                    m("input[type=text][placeholder=Description]", {
						class: 'input is-rounded',
						id: 'description',
						 oninput: function (e) {
							 CreatePetition.body=e.target.value},
						 }),
                    m('br'),
                    m("label",{for:"tag"},"Tag :"),
                    m("input[type=text][placeholder=Tag]", {
						class: 'input is-rounded',
						id: 'tag',
						 oninput: function (e) {
							 CreatePetition.tag=e.target.value},
                         }),
                    m('br'),
					m('button',{
						class: 'button',
						onclick: function(e) {
							if(document.getElementById('titre').value=="" || document.getElementById('description').value=="" ){
								alert("Veuillez renseigner le titre et la description !");
							}
							else Petition.save();
						}
					},"Submit"),))
                ])
                    ])
	    }	
    }
    
    var Petition = {
		ID:"",
		nextToken:"",
	    listtop100: [],
        listowner: [],
        listpetitiontag: [],
	    loadList: function() {
	        return m.request({
	            method: "GET",
	            url: "_ah/api/myApi/v1/entitycollection/"
	        })
	        .then(function(result) {
	            Petition.listtop100 = result.items
	        	console.log("got:",result.items) 
	        })
	    },
	    loadListOwner: function() {
	        return m.request({
	            method: "GET",
	            url: "_ah/api/myApi/v1/collectionresponse_entity/"+'?access_token='+encodeURIComponent(Petition.ID)
	        })
	        .then(function(result) {
	            Petition.listowner = result.items
	        	console.log("got:",result.items)
	        })
        },
	    save: function() {
	    	console.log("saving...",CreatePetition.current)
	    	var data={'titre': CreatePetition.titre,'body':CreatePetition.body, 'tag' : CreatePetition.tag}
	        return m.request({
	            method: "POST",
	            url: "_ah/api/myApi/v1/addPetition"+'?access_token='+encodeURIComponent(Petition.ID),
	            params: data,
	        })
	        .then(function(result) {
	        	console.log("got:",result)
	        	alert("Pétition créée...");
	        	m.route.set("/home")
	        })
	    },
	    sign: function(key) {
	    	console.log("signing...",key)
	    	var data={'key': key}
	        return m.request({
	            method: "POST",
	            url: "_ah/api/myApi/v1/signPetition"+'?access_token='+encodeURIComponent(Petition.ID),
	            params: data,
	        })
	        .then(function(result) {
	        	console.log("got:",result.key.name)
	        	if(result.key.name == "false"){
	        		alert("Vous venez de signer la pétition");
	        	}
	        	else{
	        		alert("Vous avez déjà signé cette pétition");
                }
	        })
        },
        search : function(tag) {
            console.log("searching...", tag)
            var data={'tag':tag}
            return m.request({
                method: "GET",
                url : "_ah/api/myApi/v1/entitycollection/"+tag,
                params: data,
            })
            .then(function(result) {
                console.log("got:",result)
                Petition.listpetitiontag = result.items
                m.route.set("/petitionByTag")
            })
        }
    }
    
    var ListPetitionView = {
  oninit: Petition.loadList,
  view: function() {
   	return m('div', [
           m("div", {},m(navbar)),
	  m('div',{}, "Le top 100 des pétitions"),
	  m('table', {class:'table is-striped'},[
	    m('tr', [
          m('th', {width:"300px"}, "propriétaire"),
          m('th', {width:"300px"}, "titre"),
          m('th', {width:"300px"}, "description"),
          m('th', {width:"300px"}, "tag"),
	      m('th', {width:"150px"}, "nombre de signatures"),
	      m('th', {width:"60px"}, "signer ?"),
	    ]),
	    Petition.listtop100.map(function(item) {
	      return m("tr", [
            m('td', m('label', item.properties.owner)),
            m('td', m('label', item.properties.titre)),
            m('td', m('label', item.properties.body)),
            m('td', m('label', item.properties.tag)),
	        m('td', m('label', item.properties.nbSignatory)),
	        m('button',{
				class: 'button is-link',
				onclick: function(e) {Petition.sign(item.key.name,Petition.ID)}},"sign"), 
            ])
	    })
	   ])
	 ])
  }
}

var UserListPetitionView = {
		  view: function() {
		   	return m('div', [
              m('div',{}, m(navbar)),
			  m('div',{},"Petition signée par vous"),
			  m('table', {class:'table is-striped'},[
			    m('tr', [
                  m('th', {width:"200px"}, "titre"),
                  m('th', {width:"200px"}, "description"),
                  m('th', {width:"200px"}, "tag"),
			      m('th', {width:"50px"}, "nombre de signatures"),
			    ]),
			    Petition.listowner.map(function(item) {
			      return m("tr", [
                      m('td', m('label', item.properties.titre)),
                      m('td', m('label', item.properties.body)),
                      m('td', m('label', item.properties.tag)),
			        m('td', m('label', item.properties.nbSignatory)), 
			      ])
			    })
			   ])
			 ])
		  }
        } 

        var ListPetitionByTagView = {
		  view: function() {
		   	return m('div', [
              m('div',{}, m(navbar)),
			  m('div',{},"Petitions trouvée via le tag recherché"),
			  m('table', {class:'table is-striped'},[
			    m('tr', [
                  m('th', {width:"200px"}, "titre"),
                  m('th', {width:"200px"}, "description"),
                  m('th', {width:"200px"}, "tag"),
			      m('th', {width:"50px"}, "nombre de signatures"),
			    ]),
			    Petition.listpetitiontag.map(function(item) {
			      return m("tr", [
                      m('td', m('label', item.properties.titre)),
                      m('td', m('label', item.properties.body)),
                      m('td', m('label', item.properties.tag)),
			        m('td', m('label', item.properties.nbSignatory)), 
			      ])
			    })
			   ])
			 ])
		  }
        }

function onSignIn(googleUser) {
  var profile = googleUser.getBasicProfile();
  Petition.ID=googleUser.getAuthResponse().id_token;
  m.route.set("/home")
}

var Login = {
  view: function() {
 	return m('div', {class:'container'}, [
      m("h1", {class: 'title'}, 'TinyPet'),
      m("div", {
      	   "class":"g-signin2",
      	   "data-theme":"dark",
      	   "data-onsuccess": "onSignIn"}),
      ])
    }
}
m.route(document.body, "/home", {
  "/home": { onmatch: function() {
            	if (Petition.ID=="") {m.route.set("/login")}
            	else return ListPetitionView
                }},
                "/new" : { onmatch: function(){
		  if (Petition.ID=="") {m.route.set("/login")}
      	  else return NewPetitionView
      }},
       "/myPet" : { onmatch: function(){
		  if (Petition.ID=="") {m.route.set("/login")}
      	  else return UserListPetitionView
      }},
      "/petitionByTag" : { onmatch: function() {
         return ListPetitionByTagView
      }},
  "/login": Login
}) 

   
    </script>
</body>
</html>
